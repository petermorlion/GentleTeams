<?php

/**
* @file
* A custom module for Gentle Ultimate Frisbee and organizing users in teams.
*/

/**
* Implements hook_help.
*
* Displays help and module information.
*
* @param path
*   Which path of the site we're using to display help
* @param arg
*   Array that holds the current path as returned from arg() function
*/
function gentle_teams_help($path, $arg) {
  switch ($path) {
    case "admin/help#gentle_teams":
      return '<p>' . t("A custom module for Gentle Ultimate Frisbee and organizing users in teams.") . '</p>';
      break;
  }
}

/**
* Implementation of hook_menu
*/
function gentle_teams_menu() {
    $items['admin/gentle_teams'] = array(
        'title' => 'Teams',
        'description' => 'Managing Gentle teams.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('gentle_teams_season_overview_form'),
        'access arguments' => array('manage gentle_teams'),
        'type' => MENU_NORMAL_ITEM,
    );
    
    $items['admin/gentle_teams/seasons'] = array(
        'title' => 'Seasons',
        'description' => 'Overview of the Gentle seasons.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('gentle_teams_season_overview_form'),
        'access arguments' => array('manage gentle_teams'),
        'type' => MENU_DEFAULT_LOCAL_TASK,
        'weight' => 0
    );

    $items['admin/gentle_teams/seasons/add'] = array(
        'title' => 'Add season',
        'description' => 'Page to add a season.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('gentle_teams_add_season_form'),
        'access arguments' => array('manage gentle_teams')
    );

    return $items;
}

/**
 * Valid permissions for this module
 * @return array An array of valid permissions for the gentle_teams module
 */
function gentle_teams_perm() {
    return array('manage gentle_teams');
}

/**
 * Implementation of hook_permission. Provides the permissions so they can be selected on the Permissions page.
 */
function gentle_teams_permission() {
    return array(
        'manage gentle_teams' => array(
            'title' => t('Manage Gentle teams.'),
            'description' => t('Allow a user to manage the Gentle Teams.')
        ),
    );
}

/**
 * Returns the form for the seasons overview.
 */
function gentle_teams_season_overview_form() {
    global $base_url;

    $form = array();
    $form['#prefix'] = "<p><a href='" . $base_url . "/admin/gentle_teams/seasons/add'>" . t("Add season") . "</a></p>";

    $header = array(
        array(
            'data' => 'Begin',
            'field' => 'begin',
            'sort' => 'asc'
        ),
        array(
            'data' => 'End',
            'field' => 'end'
        )
    );

    $rows = array();

    $rs = db_query('SELECT id, begin, end FROM {gentle_teams_season}');

    foreach($rs as $row) {
        $rows[$row->id] = array($row->begin, $row->end);
    }

    
    $form['gentle_teams_season_overview'] = array(
        '#type' => 'tableselect',
        '#header' => $header,
        '#options' => $rows,
        '#empty' => t('There are no seasons defined yet.'),
        '#multiple' => TRUE,
    );

    $form['submit_button'] = array(
        '#type' => 'submit',
        '#value' => t('Delete selected'),
    );

    return $form;
}

/**
 * Validates the form for the seasons overview.
 */
function gentle_teams_season_overview_form_validate($form, &$form_state) {
    foreach($form_state['values']['gentle_teams_season_overview'] as $rid) {
        db_delete('gentle_teams_season')
            ->condition('id', $rid)
            ->execute();
    }

    drupal_set_message(t('The selected seasons have been deleted.'));  
}

/**
 * The form for adding a season
 */
function gentle_teams_add_season_form() {
    $form = array();

    $years = array();
    for ($i = 2010; $i <= 2050; $i++) {
        $years[$i] = $i;
    }

    $form['gentle_teams_add_season_begin'] = array(
        '#type' => 'select',
        '#title' => t('Begin'),
        '#description' => t('The year when the season starts.'),
        '#options' => $years,
    );

    $form['gentle_teams_add_season_end'] = array(
        '#type' => 'select',
        '#title' => t('End'),
        '#description' => t('The year when the season ends.'),
        '#options' => $years,
    );

    $form['submit_button'] = array(
        '#type' => 'submit',
        '#value' => t('Submit'),
    );

    return $form;
}

/**
 * Validating the form to add a season.
 */
function gentle_teams_add_season_form_validate($form, &$form_state) {
    // TODO: check if season already exists
    $begin = intval($form_state['values']['gentle_teams_add_season_begin']);
    $end = intval($form_state['values']['gentle_teams_add_season_end']);
    if ($begin > $end) {
        form_set_error('gentle_teams_add_season_begin', t('The begin year must be smaller than or equal to the end year.'));
    }
}

/**
 * Submitting the form to add a season.
 */
function gentle_teams_add_season_form_submit($form, &$form_state) {
    $begin = intval($form_state['values']['gentle_teams_add_season_begin']);
    $end = intval($form_state['values']['gentle_teams_add_season_end']);
    db_insert('gentle_teams_season')
        ->fields(array(
            'begin' => $begin,
            'end' => $end,
        ))
        ->execute();

    drupal_set_message(t('The season was added.'));
    $form_state['redirect'] = 'admin/gentle_teams/seasons';
}